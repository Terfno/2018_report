# 2018/11/19 マイコン2
## 目的
まず、ステッピングモータを理解し、制御することが今回のっ目的です。
さらに、スイッチの操作の復習も行います。
## issue
* [x] 表紙修正
* [x] プログラムのコメント
## 装置
### ステッピングモータとは
ステッピングモータは普通のモータとは異なり、パルス信号が入力されるごとに一定の角度ずつ回転させることができるモータです。
一定の角度回転させることができるので、装置の位置を制御するのに適しているモータです。
ステッピングモータは周囲につけられたコイル(ステータ)と、回転軸に固定された磁石(ロータ)で構成されます。コイルに電流を流すことで次回が生じ、その次回により磁石が引き寄せられることで、ステッピングモータは一定角度回転します。
コイルへの電流の流し方を変えることで、異なった性質を持つ回転を作り出すことができます。
### 装置セッティング
MT-Zの拡張パーツであるステッピングモータを用いる。
## 実験
### 課題1
表1.1は1相励磁回転のドライブパターンです。1相励磁回転をさせなさい。
<div style="text-align:center;">表1.1 1相励磁回転のドライブパターン</div>

| ステップ | PB0 | PB1 | PB2 | PB3 | 
|------|-----|-----|-----|-----| 
| 0    | 1   | 0   | 0   | 0   | 
| 1    | 0   | 1   | 0   | 0   | 
| 2    | 0   | 0   | 1   | 0   | 
| 3    | 0   | 0   | 0   | 1   | 

プログラムを表1.2に示す。
<div style="text-align:center;">表1.2 課題1</div>

| アドレス | 機械語      | ラベル     | ニーモニック       | コメント             | 
|------|----------|---------|--------------|------------------| 
| 5    |          |         | PB EQU 05H   |                  | 
| 7    |          |         | CTL EQU 07H  |                  | 
| 91   |          |         | CLWD EQU 90H |                  | 
|      |          |         |              |                  | 
| 8400 |          |         | ORG 8400H    |                  | 
| 8400 | 3E 90    | STPMTR: | LD A, CLWD   | 初期設定             | 
| 8402 | D307     |         | OUT(CTL),A   | 初期設定             | 
| 8404 | 3E 01    | LOOP:   | LD A, 01H    | Aレジスタに01Hをロード    | 
| 8406 | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8408 | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 840B | 3E 02    |         | LD A, 02H    | Aレジスタに02Hをロード    | 
| 840D | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 540F | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8412 | 3E 04    |         | LD A,04H     | Aレジスタに04Hをロード    | 
| 8414 | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8416 | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8419 | 3E 08    |         | LD A, 08H    | Aレジスタに08Hをロード    | 
| 841B | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 841D | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8420 | C3 04 84 |         | JP LOOP      | LOOPにジャンプ        | 
|      |          |         |              |                  | 
| 8440 |          |         | ORG 8440H    |                  | 
| 8440 | 21 00 40 | TIMER:  | LD HL, 4000H | HLレジスタに4000Hをロード | 
| 8443 | 5F       |         | LD E, A      | EレジスタにAレジスタをロード  | 
| 8444 | 2B       | TLOOP:  | DEC HL       | HLレジスタから１を引く     | 
| 8445 | 7C       |         | LD A, H      | AレジスタにHレジスタをロード  | 
| 8446 | B5       |         | OR L         | LとORをとる          | 
| 8447 | 20 FB    |         | JR NZ TLOOP  | NZのときTLOOPにジャンプ  | 
| 8449 | 7B       |         | LD A,E       | AレジスタにEレジスタをロード  | 
| 844A | C9       |         | RET          | サブルーチンを修了        | 
| 844B |          |         | END          |                  | 


### 課題2
課題1のプログラムを参考に、ステッピングモータを2相励磁回転させよ。
プログラムを表2.1に示す。
<div style="text-align:center;">表2.1 課題2</div>

| アドレス | 機械語      | ラベル     | ニーモニック       | コメント             | 
|------|----------|---------|--------------|------------------| 
| 5    |          |         | PB EQU 05H   |                  | 
| 7    |          |         | CTL EQU 07H  |                  | 
| 91   |          |         | CLWD EQU 90H |                  | 
|      |          |         |              |                  | 
| 8400 |          |         | ORG 8400H    |                  | 
| 8400 | 3E 90    | STPMTR: | LD A, CLWD   | 初期設定             | 
| 8402 | D307     |         | OUT(CTL),A   | 初期設定             | 
| 8404 | 3E 03    | LOOP:   | LD A, 01H    | Aレジスタに01Hをロード    | 
| 8406 | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8408 | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 840B | 3E 06    |         | LD A, 02H    | Aレジスタに02Hをロード    | 
| 840D | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 540F | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8412 | 3E 0C    |         | LD A,04H     | Aレジスタに04Hをロード    | 
| 8414 | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8416 | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8419 | 3E 09    |         | LD A, 08H    | Aレジスタに08Hをロード    | 
| 841B | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 841D | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8420 | C3 04 84 |         | JP LOOP      | LOOPにジャンプ        | 
|      |          |         |              |                  | 
| 8440 |          |         | ORG 8440H    |                  | 
| 8440 | 21 00 40 | TIMER:  | LD HL, 4000H | HLレジスタに4000Hをロード | 
| 8443 | 5F       |         | LD E, A      | EレジスタにAレジスタをロード  | 
| 8444 | 2B       | TLOOP:  | DEC HL       | HLレジスタから１を引く     | 
| 8445 | 7C       |         | LD A, H      | AレジスタにHレジスタをロード  | 
| 8446 | B5       |         | OR L         | LとORをとる          | 
| 8447 | 20 FB    |         | JR NZ TLOOP  | NZのときTLOOPにジャンプ  | 
| 8449 | 7B       |         | LD A,E       | AレジスタにEレジスタをロード  | 
| 844A | C9       |         | RET          | サブルーチンを修了        | 
| 844B |          |         | END          |                  | 


### 課題3
課題1のプログラムを参考に1-2相励磁回転させよ。
プログラムを表3.1に示す。
<div style="text-align:center;">表3.1 課題3</div>

| アドレス | 機械語      | ラベル    | ニーモニック       | コメント             | 
|------|----------|--------|--------------|------------------| 
| 8400 |          |        | ORG 8400H    |                  | 
| 8400 | 3E 90    |        | LD A, CLWD   | 初期設定             | 
| 8402 | D3 07    |        | OUT(CTL),A   | 初期設定             | 
| 8404 | 3E 01    | LOOP   | LD A, 01H    | Aレジスタに01Hをロード    | 
| 8406 | D3 05    |        | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8408 | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 840B | 3E 03    |        | LD A, 03H    | Aレジスタに08Hをロード    | 
| 840D | D3 05    |        | OUT(PB), A   | Aレジスタをアウトプット     | 
| 840F | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 8412 | 3E 02    |        | LD A, 02H    | Aレジスタに02Hをロード    | 
| 8414 | D3 05    |        | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8416 | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 8419 | 3E 06    |        | LD A, 06H    | Aレジスタに06Hをロード    | 
| 841B | D3 05    |        | OUT(PB), A   | Aレジスタをアウトプット     | 
| 841D | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 8420 | 3E 04    |        | LD A, 04H    | Aレジスタに04Hをロード    | 
| 8422 | D3 05    |        | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8424 | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 8427 | 3E 0C    |        | LD A, 0CH    | Aレジスタに0CHをロード    | 
| 8429 | D3 05    |        | OUT(PB), A   | Aレジスタをアウトプット     | 
| 842B | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 842E | 3E 08    |        | LD A, 08H    | Aレジスタに08Hをロード    | 
| 8430 | D3 05    |        | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8432 | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 8435 | 3E 09    |        | LD A, 09H    | Aレジスタに09Hをロード    | 
| 8437 | D3 05    |        | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8439 | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 843C | C3 04 84 |        | JP LOOP      | LOOPにジャンプ        | 
|      |          |        |              |                  | 
| 8440 |          |        |              |                  | 
| 8440 | 21 00 00 | TIMER: | LD HL, 0000H | HLレジスタに0000Hをロード | 
| 8443 | 5F       |        | LD E, A      | EレジスタにAレジスタをロード  | 
| 8444 | 2B       | TLOOP: | DEC HL       | HLレジスタから１を引く     | 
| 8445 | 7C       |        | LD A, H      | AレジスタにHレジスタをロード  | 
| 8446 | B5       |        | OR L         | LとORをとる          | 
| 8447 | 20 FB    |        | JR NZ TLOOP  | NZのときTLOOPにジャンプ  | 
| 8449 | C9       |        | RET          | サブルーチンを修了        | 


### 課題4
課題1で作ったプログラムを改造し、徐々に速度を速くしましょう。
プログラムを表4.1に示す。
<div style="text-align:center;">表4.1 課題4</div>

| アドレス | 機械語      | ラベル     | ニーモニック       | コメント             | 
|------|----------|---------|--------------|------------------| 
| 5    |          |         | PB EQU 05H   |                  | 
| 7    |          |         | CTL EQU 07H  |                  | 
| 91   |          |         | CLWD EQU 90H |                  | 
|      |          |         |              |                  | 
| 8400 |          |         | ORG 8400H    |                  | 
| 8400 | 3E 90    | STPMTR: | LD A, CLWD   | 初期設定             | 
| 8402 | D307     |         | OUT(CTL),A   | 初期設定             | 
| 8404 | 3E 01    | LOOP:   | LD A, 01H    | Aレジスタに01Hをロード    | 
| 8406 | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8408 | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 840B | 3E 02    |         | LD A, 02H    | Aレジスタに02Hをロード    | 
| 840D | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 540F | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8412 | 3E 04    |         | LD A,04H     | Aレジスタに04Hをロード    | 
| 8414 | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8416 | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8419 | 3E 08    |         | LD A, 08H    | Aレジスタに08Hをロード    | 
| 841B | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 841D | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8420 | C3 04 84 |         | JP LOOP      | LOOPにジャンプ        | 
|      |          |         |              |                  | 
| 8440 |          |         | ORG 8440H    |                  | 
| 8440 | 21 61 00 | TIMER:  | LD HL, 4000H | HLレジスタに4000Hをロード | 
| 8443 | 5F       |         | LD E, A      | EレジスタにAレジスタをロード  | 
| 8444 | 2B       | TLOOP:  | DEC HL       | HLレジスタから１を引く     | 
| 8445 | 7C       |         | LD A, H      | AレジスタにHレジスタをロード  | 
| 8446 | B5       |         | OR L         | LとORをとる          | 
| 8447 | 20 FB    |         | JR NZ TLOOP  | NZのときTLOOPにジャンプ  | 
| 8449 | 7B       |         | LD A,E       | AレジスタにEレジスタをロード  | 
| 844A | C9       |         | RET          | サブルーチンを修了        | 
| 844B |          |         | END          |                  | 


結果として0060だと止まり、0061が最速でした。
### 課題5
課題1で作ったプログラムを改造し、逆回転させなさい。
プログラムを表5.1に示す。
<div style="text-align:center;">表5.1 課題5</div>

| アドレス | 機械語      | ラベル     | ニーモニック       | コメント             | 
|------|----------|---------|--------------|------------------| 
| 5    |          |         | PB EQU 05H   |                  | 
| 7    |          |         | CTL EQU 07H  |                  | 
| 91   |          |         | CLWD EQU 90H |                  | 
|      |          |         |              |                  | 
| 8400 |          |         | ORG 8400H    |                  | 
| 8400 | 3E 90    | STPMTR: | LD A, CLWD   | 初期設定             | 
| 8402 | D307     |         | OUT(CTL),A   | 初期設定             | 
| 8404 | 3E 08    | LOOP:   | LD A, 08H    | Aレジスタに08Hをロード    | 
| 8406 | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8408 | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 840B | 3E 04    |         | LD A, 04H    | Aレジスタに04Hをロード    | 
| 840D | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 540F | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8412 | 3E 02    |         | LD A,02H     | Aレジスタに02Hをロード    | 
| 8414 | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 8416 | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8419 | 3E 01    |         | LD A, 01H    | Aレジスタに01Hをロード    | 
| 841B | D3 05    |         | OUT(PB), A   | Aレジスタをアウトプット     | 
| 841D | CD 40 84 |         | CALL TIMER   | TIMERを呼び出し       | 
| 8420 | C3 04 84 |         | JP LOOP      | LOOPにジャンプ        | 
|      |          |         |              |                  | 
| 8440 |          |         | ORG 8440H    |                  | 
| 8440 | 21 00 40 | TIMER:  | LD HL, 4000H | HLレジスタに4000Hをロード | 
| 8443 | 5F       |         | LD E, A      | EレジスタにAレジスタをロード  | 
| 8444 | 2B       | TLOOP:  | DEC HL       | HLレジスタから１を引く     | 
| 8445 | 7C       |         | LD A, H      | AレジスタにHレジスタをロード  | 
| 8446 | B5       |         | OR L         | LとORをとる          | 
| 8447 | 20 FB    |         | JR NZ TLOOP  | NZのときTLOOPにジャンプ  | 
| 8449 | 7B       |         | LD A,E       | AレジスタにEレジスタをロード  | 
| 844A | C9       |         | RET          | サブルーチンを修了        | 
| 844B |          |         | END          |                  | 


### 課題6
スイッチの状態を読み込んでLEDに出力するプログラムを作りなさい。
プログラムを表6.1に示す。

<div style="text-align:center;">表6.1 課題6</div>

| アドレス | 機械語      | ラベル   | ニーモニック      | コメント      | 
|------|----------|-------|-------------|-----------| 
| 4    |          | PA    | EQU 04H     |           | 
| 5    |          | PB    | EQU 05H     |           | 
| 7    |          | CTL   | EQU 07H     |           | 
| 9    |          | CTLWD | EQU 90H     |           | 
|      |          |       |             |           | 
| 8400 |          |       | ORG 8400H   |           | 
| 8400 | 3E 90    |       | LD A, CLWD  | 初期設定      | 
| 8402 | D3 07    |       | OUT (CTL),A | 初期設定      | 
| 8404 | DB 04    | LOOP: | IN A,(PA)   | Aポートから入力  | 
| 8406 | D3 05    |       | OUT (PB),A  | Aレジスタを出力  | 
| 8408 | C3 04 84 |       | JP LOOP     | LOOPにジャンプ | 
| 840B |          |       | END         |           | 


### 課題7
スイッチの右端がONの場合LEDを点灯を左にシフトし、OFFの場合停止させるプログラムを作りなさい。
プログラムを表7.1に示す。
<div style="text-align:center;">表7.1 課題7</div>

| アドレス | 機械語      | ラベル    | ニーモニック       | コメント             | 
|------|----------|--------|--------------|------------------| 
| 8400 |          |        | ORG 8400H    |                  | 
| 8400 | 3E 90    |        | LD A (CTLW)  | 初期設定             | 
| 8402 | D3 07    |        | OUT (CTL)A   | 初期設定             | 
| 8404 | 3E 01    |        | LD A 01H     | Aレジスタに01Hをロード    | 
| 8406 | D3 05    |        | OUT (PB) A   | Aレジスタの内容を出力      | 
| 8408 | CD 40 84 |        | CALL TIMER   | TIMER呼び出し        | 
| 840B | 47       |        | LD B A       | BレジスタにAレジスタをロード  | 
| 840C | DB 04    |        | IN A(PA)     | Aポートから入力         | 
| 840E | E6 01    |        | AND 01H      | 01HでAND          | 
| 8410 | FE 01    |        | CP 01H       | 01Hと比較           | 
| 8412 | C2 1A 84 |        | JP NZ LOOP   | 0じゃなければLOOPにジャンプ | 
| 8415 | 78       |        | LD A B       | AレジスタにBレジスタをロード  | 
| 8416 | 7        |        | RL CA        | 右シフト             | 
| 8417 | C3 06 84 |        | JP 06 84     | 8406Hにジャンプ       | 
| 841A | 78       | LOOP:  | LD A, B      | AレジスタにBレジスタをロード  | 
| 841B | C3 06 84 |        | JP 06 84     | 8406Hにジャンプ       | 
|      |          |        |              |                  | 
| 8440 |          |        | ORG 8440H    |                  | 
| 8440 | 21 00 40 | TIMER: | LD HL, 4000H | HLレジスタに4000Hをロード | 
| 8443 | 5F       |        | LD E, A      | EレジスタにAレジスタをロード  | 
| 8444 | 2B       | TLOOP: | DEC HL       | HLレジスタから１を引く     | 
| 8445 | 7C       |        | LD A, H      | AレジスタにHレジスタをロード  | 
| 8446 | B5       |        | OR L         | LとORをとる          | 
| 8447 | 20 FB    |        | JR NZ TLOOP  | NZのときTLOOPにジャンプ  | 
| 8449 | 7B       |        | LD A,E       | AレジスタにEレジスタをロード  | 
| 844A | C9       |        | RET          | サブルーチンを修了        | 
| 844B |          |        | END          |                  | 


### 課題8
2つの4桁の2進数の数値を入力し、それを加算し、結果をLEDで表示するプログラムを作りなさい。
数値を入力する場合は、スイッチの右4つ、左4つそれぞれの状態を2つの4桁の数とします。
プログラムを表8.1に示す。
<div style="text-align:center;">表8.1 課題8</div>

| アドレス | 機械語      | ラベル   | ニーモニック      | コメント            | 
|------|----------|-------|-------------|-----------------| 
| 8400 |          |       |             |                 | 
| 8400 | 3E 90    |       | LD A, CLWD  | 初期設定            | 
| 8402 | D3 07    |       | OUT(CTL), A | 初期設定            | 
| 8404 | DB 04    | LOOP: | IN A, 04H   | Aポートから入力        | 
| 8406 | 47       |       | LD B, A     | BレジスタにAレジスタをロード | 
| 8407 | E6 0FH   |       | AND 0FH     | 0FHでAND         | 
| 8409 | 32 00 85 |       | LD 8500H, A | 8500HにAレジスタをロード | 
| 840C | 78       |       | LD A, B     | AレジスタにBレジスタをロード | 
| 840D | E6 F0H   |       | AND F0H     | F0HでAND         | 
| 840F | 0F       |       | RRCA        | 右シフト            | 
| 8410 | 0F       |       | RRCA        | 右シフト            | 
| 8411 | 0F       |       | RRCA        | 右シフト            | 
| 8412 | 0F       |       | RRCA        | 右シフト            | 
| 8413 | 47       |       | LD B, A     | BレジスタにAレジスタをロード | 
| 8414 | 3A 00 85 |       | LD A, 8500H | Aレジスタに8500Hをロード | 
| 8417 | 80       |       | ADD A, B    | AとBを足す          | 
| 8418 | D3 05    |       | OUT(PB) A   | Aレジスタを出力        | 
| 841A | C3 00 00 |       | END         | 終了              | 


## 考察課題
### 考察課題1
タイマーサブルーチンはなぜ必要か答えなさい。

何度も使用するのでサブルーチンを使用しないとプログラムが長くなってしまい、入力に時間がかかる上、ミスを誘発するため

### 考察課題2
今回は3種類のドライブのしかたを行った
各ドライブパターンの特徴を調べて報告しましょう。

1相励磁回転：位置決め精度が高い。
2相励磁回転：1相励磁回転と比べてトルクが大きい。
1-2相励磁回転：1相励磁回転と2相励磁回転を交互に行う。そのため、なめらかに動く。

### 考察課題3
回転速度を速くしようと数値を変えていくと、いずれモータが回転しなくなる。回転しなくなる理由をステッピングモータの動作原理に基づいて説明せよ。

ステッピングモータの場合、対になっているコイル同士が共振することで騒音、振動はあるが動かないあるいはゆったり動く、脱調という現象が発生し、数値を上げても回転しなくなってしまう。
